<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <title>Säästölaskurin testit</title>
    <style>
        body { font-family: system-ui; padding: 20px; max-width: 600px; margin: 0 auto; }
        h1 { font-size: 1.2em; }
        .test { margin: 6px 0; padding: 4px 0; }
        .ok { color: green; }
        .fail { color: red; }
        .section { margin-top: 16px; font-weight: bold; }
        #tulos { margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 6px; }
    </style>
</head>
<body>
    <h1>Säästölaskurin testit</h1>
    <div id="tulos"></div>

    <script>
        function parseDate(arr) { return new Date(arr[0], arr[1], arr[2]).getTime(); }
        function getDaysInMonth(date) { return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate(); }

        function calculateSavings(history, start, end) {
            let total = 0;
            for (let i = 0; i < history.length; i++) {
                const entry = history[i];
                const entryStart = parseDate(entry.alkaen);
                let entryEnd = (i + 1 < history.length) ? parseDate(history[i+1].alkaen) : end;
                const activeStart = Math.max(entryStart, start);
                const activeEnd = Math.min(entryEnd, end);
                if (activeEnd <= activeStart) continue;
                let current = activeStart;
                while (current < activeEnd) {
                    const currentDate = new Date(current);
                    const monthStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getTime();
                    const monthEnd = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0, 23, 59, 59, 999).getTime();
                    const segmentEnd = Math.min(monthEnd + 1, activeEnd);
                    const segmentMs = segmentEnd - current;
                    const monthMs = monthEnd + 1 - monthStart;
                    total += (segmentMs / monthMs) * entry.summa;
                    current = segmentEnd;
                }
            }
            return total;
        }

        let passed = 0, failed = 0;
        const out = document.getElementById("tulos");

        function add(msg, ok) {
            const p = document.createElement("div");
            p.className = "test " + (ok ? "ok" : "fail");
            p.textContent = (ok ? "✓ " : "✗ ") + msg;
            out.appendChild(p);
            if (ok) passed++; else failed++;
        }

        function section(title) {
            const p = document.createElement("div");
            p.className = "section";
            p.textContent = title;
            out.appendChild(p);
        }

        // 1. Koko kuukausi – eri määrät
        section("1. Koko kuukausi (eri määrät)");
        const tammiAlku = new Date(2026, 0, 1).getTime();
        const tammiLoppu = new Date(2026, 0, 31, 23, 59, 59, 999).getTime() + 1;
        for (const summa of [100, 410, 870, 1000]) {
            const h = [{ alkaen: [2026, 0, 1], summa }];
            const t = calculateSavings(h, tammiAlku, tammiLoppu);
            add(`${summa} € tammikuussa → ${t.toFixed(2)} € (odotus ${summa})`, Math.abs(t - summa) < 0.01);
        }

        // 2. Puolikas kuukausi
        section("2. Puolikas kuukausi (15 päivää)");
        const tammi15 = new Date(2026, 0, 15, 23, 59, 59, 999).getTime() + 1;
        const h410 = [{ alkaen: [2026, 0, 1], summa: 410 }];
        const puolikas = calculateSavings(h410, tammiAlku, tammi15);
        const odotus15 = 410 * (15 / 31);
        add(`410 € × 15/31 päivää → ${puolikas.toFixed(2)} € (odotus ~${odotus15.toFixed(2)})`, Math.abs(puolikas - odotus15) < 0.5);

        // 3. Helmikuu 28 vs 29 päivää
        section("3. Helmikuu – 28 vs 29 päivää (karkausvuosi)");
        const helmi2025 = new Date(2025, 1, 1).getTime();
        const helmi2025Loppu = new Date(2025, 1, 28, 23, 59, 59, 999).getTime() + 1;
        const helmi2024 = new Date(2024, 1, 1).getTime();
        const helmi2024Loppu = new Date(2024, 1, 29, 23, 59, 59, 999).getTime() + 1;
        const t25 = calculateSavings([{ alkaen: [2025, 1, 1], summa: 100 }], helmi2025, helmi2025Loppu);
        const t24 = calculateSavings([{ alkaen: [2024, 1, 1], summa: 100 }], helmi2024, helmi2024Loppu);
        add(`2025 helmikuu (28 pv): ${t25.toFixed(2)} €`, Math.abs(t25 - 100) < 0.01);
        add(`2024 helmikuu (29 pv): ${t24.toFixed(2)} €`, Math.abs(t24 - 100) < 0.01);

        // 4. Useampi kuukausi
        section("4. Useampi kuukausi (tammi–maalis 2026)");
        const maalisLoppu = new Date(2026, 2, 31, 23, 59, 59, 999).getTime() + 1;
        const kolmeKk = calculateSavings(h410, tammiAlku, maalisLoppu);
        add(`410 € × 3 kk yhteensä → ${kolmeKk.toFixed(2)} € (odotus 1230)`, Math.abs(kolmeKk - 1230) < 0.5);

        // 4b. Eri kuukaudet erikseen – tarkista että jokainen kk lasketaan oikein (eri päivämäärät)
        section("4b. Eri kuukaudet erikseen (410 €/kk, eri päivämäärät)");
        const tammiKk = calculateSavings(h410, new Date(2026, 0, 1).getTime(), new Date(2026, 0, 31, 23, 59, 59, 999).getTime() + 1);
        const helmiKk = calculateSavings(h410, new Date(2026, 1, 1).getTime(), new Date(2026, 1, 28, 23, 59, 59, 999).getTime() + 1);
        const maalisKk = calculateSavings(h410, new Date(2026, 2, 1).getTime(), new Date(2026, 2, 31, 23, 59, 59, 999).getTime() + 1);
        add(`Tammikuu (31 pv): ${tammiKk.toFixed(2)} €`, Math.abs(tammiKk - 410) < 0.01);
        add(`Helmikuu (28 pv): ${helmiKk.toFixed(2)} €`, Math.abs(helmiKk - 410) < 0.01);
        add(`Maaliskuu (31 pv): ${maalisKk.toFixed(2)} €`, Math.abs(maalisKk - 410) < 0.01);
        // 10 päivää per kk – helmikuussa päiväkohtainen säästö suurempi (410/28 > 410/31)
        const t10 = calculateSavings(h410, new Date(2026, 0, 1).getTime(), new Date(2026, 0, 10, 23, 59, 59, 999).getTime() + 1);
        const h10 = calculateSavings(h410, new Date(2026, 1, 1).getTime(), new Date(2026, 1, 10, 23, 59, 59, 999).getTime() + 1);
        const m10 = calculateSavings(h410, new Date(2026, 2, 1).getTime(), new Date(2026, 2, 10, 23, 59, 59, 999).getTime() + 1);
        const odotusT10 = 410 * (10/31), odotusH10 = 410 * (10/28), odotusM10 = 410 * (10/31);
        add(`10 pv tammikuussa: ${t10.toFixed(2)} € (odotus ${odotusT10.toFixed(2)})`, Math.abs(t10 - odotusT10) < 0.1);
        add(`10 pv helmikuussa: ${h10.toFixed(2)} € (odotus ${odotusH10.toFixed(2)})`, Math.abs(h10 - odotusH10) < 0.1);
        add(`10 pv maaliskuussa: ${m10.toFixed(2)} € (odotus ${odotusM10.toFixed(2)})`, Math.abs(m10 - odotusM10) < 0.1);
        add(`10 pv helmi > 10 pv tammi (${h10.toFixed(2)} > ${t10.toFixed(2)})`, h10 > t10);

        // 4c. Eri määrät per kuukausi: tammi 410 €, helmi 500 €, maalis 600 €
        section("4c. Eri määrät per kuukausi (tammi 410, helmi 500, maalis 600 €)");
        const historyEriKk = [
            { alkaen: [2026, 0, 1], summa: 410 },
            { alkaen: [2026, 1, 1], summa: 500 },
            { alkaen: [2026, 2, 1], summa: 600 }
        ];
        const tammi410 = calculateSavings(historyEriKk, new Date(2026, 0, 1).getTime(), new Date(2026, 0, 31, 23, 59, 59, 999).getTime() + 1);
        const helmi500 = calculateSavings(historyEriKk, new Date(2026, 1, 1).getTime(), new Date(2026, 1, 28, 23, 59, 59, 999).getTime() + 1);
        const maalis600 = calculateSavings(historyEriKk, new Date(2026, 2, 1).getTime(), new Date(2026, 2, 31, 23, 59, 59, 999).getTime() + 1);
        const yhteensa3kk = calculateSavings(historyEriKk, tammiAlku, maalisLoppu);
        add(`Tammikuu: ${tammi410.toFixed(2)} € (odotus 410)`, Math.abs(tammi410 - 410) < 0.01);
        add(`Helmikuu: ${helmi500.toFixed(2)} € (odotus 500)`, Math.abs(helmi500 - 500) < 0.01);
        add(`Maaliskuu: ${maalis600.toFixed(2)} € (odotus 600)`, Math.abs(maalis600 - 600) < 0.01);
        add(`Yhteensä tammi–maalis: ${yhteensa3kk.toFixed(2)} € (odotus 1510)`, Math.abs(yhteensa3kk - 1510) < 0.5);

        // 5. History-vaihto kesken kuukauden
        section("5. History-vaihto kesken kuukauden");
        const historyVaihto = [
            { alkaen: [2026, 0, 1], summa: 200 },
            { alkaen: [2026, 0, 16], summa: 400 }
        ];
        const tammiKoko = new Date(2026, 0, 31, 23, 59, 59, 999).getTime() + 1;
        const vaihto = calculateSavings(historyVaihto, tammiAlku, tammiKoko);
        const odotusV = 200 * (15/31) + 400 * (16/31);
        add(`200€ 1–15, 400€ 16–31 → ${vaihto.toFixed(2)} €`, Math.abs(vaihto - odotusV) < 1);

        // 6. Eri vuodet
        section("6. Eri vuodet (tammikuu 500 €)");
        for (const vuosi of [2024, 2025, 2026]) {
            const alku = new Date(vuosi, 0, 1).getTime();
            const loppu = new Date(vuosi, 0, 31, 23, 59, 59, 999).getTime() + 1;
            const t = calculateSavings([{ alkaen: [vuosi, 0, 1], summa: 500 }], alku, loppu);
            add(`${vuosi} tammikuu → ${t.toFixed(2)} €`, Math.abs(t - 500) < 0.01);
        }

        // 7. Nykyinen data (käytetään nykyistä vuotta, jotta tulos > 0)
        section("7. Nykyinen data (Paula 410 €, Tomi 870 €)");
        const nyt = new Date();
        const vuosi = nyt.getFullYear();
        const kkAlku = new Date(vuosi, nyt.getMonth(), 1).getTime();
        const vuosiAlku = new Date(vuosi, 0, 1).getTime();
        const paulaH = [{ alkaen: [vuosi, 0, 1], summa: 410 }];
        const tomiH = [{ alkaen: [vuosi, 0, 1], summa: 870 }];
        const pM = calculateSavings(paulaH, kkAlku, nyt.getTime());
        const tM = calculateSavings(tomiH, kkAlku, nyt.getTime());
        const pY = calculateSavings(paulaH, vuosiAlku, nyt.getTime());
        const tY = calculateSavings(tomiH, vuosiAlku, nyt.getTime());
        add(`Kuukausi: Paula ${pM.toFixed(2)} + Tomi ${tM.toFixed(2)} = ${(pM+tM).toFixed(2)} €`, (pM + tM) > 0);
        add(`Vuosi: ${(pY+tY).toFixed(2)} €`, (pY + tY) > 0);

        // Yhteenveto
        const yht = document.createElement("div");
        yht.style.marginTop = "16px";
        yht.style.fontWeight = "bold";
        yht.textContent = `Yhteenveto: ${passed} läpäisty, ${failed} epäonnistunut` + (failed === 0 ? " – Kaikki OK ✓" : "");
        out.appendChild(yht);
    </script>
</body>
</html>
