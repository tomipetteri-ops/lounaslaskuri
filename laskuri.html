<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Laskuri</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="laskuri-sivu" onclick="handleInteraction()">
        <div class="henkilo">
            <div class="label">Paula (tässä kuussa)</div>
            <div id="paula-saasto" class="euro">...</div>
        </div>
        <div class="henkilo">
            <div class="label">Tomi (tässä kuussa)</div>
            <div id="tomi-saasto" class="euro">...</div>
        </div>
        <div class="yhteensa-kuukausi">
            <div id="kuukausi-otsikko" class="label">Yhteensä</div>
            <div id="yhteensa-saasto" class="euro">...</div>
        </div>
        <div class="kaikki-yhteensa">
            <div class="label">Säästöt 2026</div>
            <div id="kaikki-saasto" class="euro">...</div>
        </div>
    </div>

    <script>
        // ==========================================
        // ASETUKSET
        // ==========================================
        const paivitysvaliSekunteina = 60;

        const paulaHistory = [
            { alkaen: [2026, 0, 1], summa: 410 }
        ];
        const tomiHistory = [
            { alkaen: [2026, 0, 1], summa: 870 }
        ];
        const vuosiAlku = [2026, 0, 1];

        const months = ["Tammikuussa","Helmikuussa","Maaliskuussa","Huhtikuussa","Toukokuussa",
                        "Kesäkuussa","Heinäkuussa","Elokuussa","Syyskuussa","Lokakuussa",
                        "Marraskuussa","Joulukuussa"];

        function parseDate(arr) { return new Date(arr[0], arr[1], arr[2]).getTime(); }
        function getDaysInMonth(date) { return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate(); }

        function calculateSavings(history, start, end) {
            let total = 0;
            for (let i = 0; i < history.length; i++) {
                const entry = history[i];
                const entryStart = parseDate(entry.alkaen);
                let entryEnd = (i + 1 < history.length) ? parseDate(history[i+1].alkaen) : end;
                const activeStart = Math.max(entryStart, start);
                const activeEnd = Math.min(entryEnd, end);
                if (activeEnd > activeStart) {
                    const seconds = (activeEnd - activeStart) / 1000;
                    const days = getDaysInMonth(new Date(activeStart));
                    total += seconds * (entry.summa / (days * 24 * 60 * 60));
                }
            }
            return total;
        }

        function update() {
            const now = new Date();
            const nowMs = now.getTime();
            const monthStartMs = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            const yearStartMs = parseDate(vuosiAlku);

            const pM = calculateSavings(paulaHistory, monthStartMs, nowMs);
            const tM = calculateSavings(tomiHistory, monthStartMs, nowMs);
            const pY = calculateSavings(paulaHistory, yearStartMs, nowMs);
            const tY = calculateSavings(tomiHistory, yearStartMs, nowMs);

            document.getElementById("paula-saasto").innerText = pM.toFixed(2) + " €";
            document.getElementById("tomi-saasto").innerText = tM.toFixed(2) + " €";
            document.getElementById("yhteensa-saasto").innerText = (pM + tM).toFixed(2) + " €";
            document.getElementById("kaikki-saasto").innerText = (pY + tY).toFixed(2) + " €";
            document.getElementById("kuukausi-otsikko").innerText = "Yhteensä " + months[now.getMonth()];
        }

        function handleInteraction() {
            update();
            if (window.parent && window.parent !== window) return;
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(() => {});
            }
        }

        window.onload = function() {
            update();
            setInterval(update, paivitysvaliSekunteina * 1000);
        };

        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") update();
        });
    
    window.addEventListener('message', function(event) {
        if (event.data === 'pysayta') {
            console.log('Pysäytetään ajastin');
            if (window.slideTimer) clearInterval(window.slideTimer);
        } else if (event.data === 'kaynnista') {
            console.log('Käynnistetään ajastin');
            // Oletetaan että kello/dia päivittyy handleInteraction tai vastaavalla
            if (typeof handleInteraction === 'function') handleInteraction();
            else location.reload(); // Vararatkaisu: päivitä sivu jos funktiota ei löydy
        }
    });

</script>
<div style="position:fixed; bottom:2px; right:5px; font-size:10px; opacity:0.3; pointer-events:none; color:gray;">v1.1_1423</div>
</body>
</html>
